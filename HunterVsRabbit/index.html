<html><head> 
 
 
<title>GLGE</title> 
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
 
 

<script type="text/javascript" src="../../glge-compiled-min.js"></script>
<script type="text/javascript" src="../../../moteur3d/moteur3d.js"></script>
<style>
body{background-color: #000;color: #fff;font-family:arial}
</style>
</head><body>

<div id="dump"></div>

<div>
<div style="width:900px;margin:auto;position:relative" id="container">
<canvas id="canvas" width="900" 
height="500"></canvas>
<div id="framerate" style="position:absolute; left: 750px; top: 20px; background-color: #000; opacity: 0.5;height: 30px; width: 130px; border-radius: 5px;	-moz-border-radius5px;-webkit-border-radius:5px;border: 1px solid #fff;">
<div id="debug" style="padding: 5px"></div>
</div>
<div style="padding: 5px;position:absolute; left: 20px; top: 370px; background-color: #000; opacity: 0.5;height: 100px; width: 400px; border-radius: 5px;	-moz-border-radius5px;-webkit-border-radius:5px;border: 1px solid #fff;">
<h2 style="margin:0;padding:0;padding-bottom: 5px;font-size: 20px">Demo du moteur3d de 3DWIGS</h2>
<p style="margin:0;padding:0;padding-bottom: 5px;">Le jeu du lapin </p>
</div>
</div>

</div>

<script type="text/javascript">

var doc = new GLGE.Document();
doc.onLoad=function(){
	//create the renderer
	var gameRenderer=new GLGE.Renderer(document.getElementById('canvas'));
	gameScene=new GLGE.Scene();
	gameScene=doc.getElement("mainscene");
	gameRenderer.setScene(gameScene);

	// Initialisation du moteur3d
	var moteur = new M3D.MOTEUR.initialisation(gameScene);
	var tabObject = moteur[0];
	var tabIdObject = moteur[1];
	var tabCamera = moteur[2];
	
	console.log(gameScene);
	/*
	// pour le débug des bounding box
	var red=doc.getElement( "red" );
	var line=(new GLGE.Object).setDrawType(GLGE.DRAW_LINES);
	var positions = [];
	
	drawBB = function(obj){ 
        var pos = obj.getPosition();
        var bbox = obj.getBoundingVolume().getCornerPoints();
        //bas gauche devant
        positions.push(bbox[0][0]);
        positions.push(bbox[0][1]);
        positions.push(bbox[0][2]);
        //bas droite devant
        positions.push(bbox[1][0]);
        positions.push(bbox[1][1]);
        positions.push(bbox[1][2]);
        //bas gauche derriere
		positions.push(bbox[4][0]);
        positions.push(bbox[4][1]);
        positions.push(bbox[4][2]);
        //bas droite derriere
        positions.push(bbox[5][0]);
        positions.push(bbox[5][1]);
        positions.push(bbox[5][2]);
        //haut gauche devant
        positions.push(bbox[2][0]);
        positions.push(bbox[2][1]);
        positions.push(bbox[2][2]);
        //haut droite devant
        positions.push(bbox[3][0]);
        positions.push(bbox[3][1]);
        positions.push(bbox[3][2]);
        //haut gauche derriere
        positions.push(bbox[6][0]);
        positions.push(bbox[6][1]);
        positions.push(bbox[6][2]);
        //haut droite derriere
        positions.push(bbox[7][0]);
        positions.push(bbox[7][1]);
        positions.push(bbox[7][2]);
        //bas droite devant
         positions.push(bbox[1][0]);
        positions.push(bbox[1][1]);
        positions.push(bbox[1][2]);
        //bas droite derriere
        positions.push(bbox[5][0]);
        positions.push(bbox[5][1]);
        positions.push(bbox[5][2]);
        //bas gauche devant
        positions.push(bbox[0][0]);
        positions.push(bbox[0][1]);
        positions.push(bbox[0][2]);
        //bas gauche derriere
        positions.push(bbox[4][0]);
        positions.push(bbox[4][1]);
        positions.push(bbox[4][2]);
        //haut gauche devant
        positions.push(bbox[2][0]);
        positions.push(bbox[2][1]);
        positions.push(bbox[2][2]);
        //haut gauche derriere
		positions.push(bbox[6][0]);
        positions.push(bbox[6][1]);
        positions.push(bbox[6][2]);
        //haut droite devant
        positions.push(bbox[3][0]);
        positions.push(bbox[3][1]);
        positions.push(bbox[3][2]);
        //haut droite derriere
		positions.push(bbox[7][0]);
        positions.push(bbox[7][1]);
        positions.push(bbox[7][2]);
        //bas gauche devant
        positions.push(bbox[0][0]);
        positions.push(bbox[0][1]);
        positions.push(bbox[0][2]);
        //haut gauche devant
        positions.push(bbox[2][0]);
        positions.push(bbox[2][1]);
        positions.push(bbox[2][2]);
        //bas gauche derriere
		positions.push(bbox[4][0]);
        positions.push(bbox[4][1]);
        positions.push(bbox[4][2]);
        //haut gauche derriere
        positions.push(bbox[6][0]);
        positions.push(bbox[6][1]);
        positions.push(bbox[6][2]);
        //bas droite derriere
        positions.push(bbox[5][0]);
        positions.push(bbox[5][1]);
        positions.push(bbox[5][2]);
        //haut droite derriere
        positions.push(bbox[7][0]);
        positions.push(bbox[7][1]);
        positions.push(bbox[7][2]);
        //bas droite devant
        positions.push(bbox[1][0]);
        positions.push(bbox[1][1]);
        positions.push(bbox[1][2]);
        //haut droite devant
        positions.push(bbox[3][0]);
        positions.push(bbox[3][1]);
        positions.push(bbox[3][2]);
        
        line.setMesh((new GLGE.Mesh).setPositions(positions));
        line.setMaterial(red);
        line.setZtransparent(true);
        gameScene.addObject(line);
	}
*/

	// Partie sur les caméras
	
	var mouse=new GLGE.MouseInput(document.getElementById('canvas'));
	var keys=new GLGE.KeyInput();
	var mouseovercanvas;
	var hoverobj;
	camLookAt = false;
	camLookPlayer = false;

	function mouselook(){
        if(mouseovercanvas){
            var mousepos=mouse.getMousePosition();
            mousepos.x=mousepos.x-document.getElementById("container").offsetLeft;
            mousepos.y=mousepos.y-document.getElementById("container").offsetTop;
            
			var camera=gameScene.camera;
            camerarot=camera.getRotation();
            inc=(mousepos.y-(document.getElementById('canvas').offsetHeight/2))/500;
			
			//var trans=camera.getRotMatrix().x([0,0,-1,1]);
            var trans=GLGE.mulMat4Vec4(camera.getRotMatrix(),[0,0,-1,1]);
            var mag=Math.pow(Math.pow(trans[0],2)+Math.pow(trans[1],2),0.5);
            trans[0]=trans[0]/mag;
            trans[1]=trans[1]/mag;
            camera.setRotX(1.56-trans[1]*inc);
            camera.setRotZ(-trans[0]*inc);
            var width=document.getElementById('canvas').offsetWidth;
            
			if(mousepos.x<width*0.3){
                var turn=Math.pow((mousepos.x-width*0.3)/(width*0.3),2)*0.005*(now-lasttime);
				camera.setRotY(camerarot.y+turn);
            }
            if(mousepos.x>width*0.7){
                var turn=Math.pow((mousepos.x-width*0.7)/(width*0.3),2)*0.005*(now-lasttime);
                camera.setRotY(camerarot.y-turn);
            }
        }
	}

	// Gestion de la caméra au clavier
	function checkkeys(object){
        var camera=gameScene.camera;
        camerapos=camera.getPosition();
        camerarot=camera.getRotation();
        var cam = camera.getRotMatrix();
        cam = GLGE.inverseMat4(cam);    

        if(keys.isKeyPressed(GLGE.KI_W)){ camLookAt = true; camLookPlayer = false; }
       
        if(keys.isKeyPressed(GLGE.KI_X)){ camLookAt = false; camLookPlayer = false; }
                        
		if(keys.isKeyPressed(GLGE.KI_C)){ camLookPlayer = true; camLookAt = false; }
       
        if(keys.isKeyPressed(GLGE.KI_V)){ camLookPlayer = false; camLookAt = false; }
		
        if(camLookAt){
                var objpos={x:0,y:0,z:0};               
                var coord=[camerapos.x-objpos.x,camerapos.y-objpos.y,camerapos.z-objpos.z];
                var zvec=GLGE.toUnitVec3(coord);
                var xvec=GLGE.toUnitVec3(GLGE.crossVec3([cam[4],cam[5],cam[6]],zvec));
                var yvec=GLGE.toUnitVec3(GLGE.crossVec3(zvec,xvec));            
                camera.setRotMatrix(GLGE.Mat4([xvec[0], yvec[0], zvec[0], 0,
                                                xvec[1], yvec[1], zvec[1], 0,
                                                xvec[2], yvec[2], zvec[2], 0,
                                                0, 0, 0, 1]));
        }

		if(camLookPlayer){
				var playerPos = object.getPosition();
                var objpos={x:playerPos.x,y:playerPos.y,z:playerPos.z};               
                var coord=[camerapos.x-objpos.x,camerapos.y-objpos.y,camerapos.z-objpos.z];
                var zvec=GLGE.toUnitVec3(coord);
                var xvec=GLGE.toUnitVec3(GLGE.crossVec3([cam[4],cam[5],cam[6]],zvec));
                var yvec=GLGE.toUnitVec3(GLGE.crossVec3(zvec,xvec));            
                camera.setRotMatrix(GLGE.Mat4([xvec[0], yvec[0], zvec[0], 0,
                                                xvec[1], yvec[1], zvec[1], 0,
                                                xvec[2], yvec[2], zvec[2], 0,
                                                0, 0, 0, 1]));
        }
		
        if(keys.isKeyPressed(GLGE.KI_Z)) {camera.setLocX(camerapos.x-cam[8]*0.05*(now-lasttime));camera.setLocY(camerapos.y-cam[9]*0.05*(now-lasttime));camera.setLocZ(camerapos.z-cam[10]*0.05*(now-lasttime));}

        if(keys.isKeyPressed(GLGE.KI_S)) {camera.setLocX(camerapos.x+cam[8]*0.05*(now-lasttime));camera.setLocY(camerapos.y+cam[9]*0.05*(now-lasttime));camera.setLocZ(camerapos.z+cam[10]*0.05*(now-lasttime));}

        if(keys.isKeyPressed(GLGE.KI_Q)) {camera.setLocX(camerapos.x-cam[0]*0.05*(now-lasttime));camera.setLocY(camerapos.y-cam[1]*0.05*(now-lasttime));camera.setLocZ(camerapos.z-cam[2]*0.05*(now-lasttime));}

        if(keys.isKeyPressed(GLGE.KI_D)) {camera.setLocX(camerapos.x+cam[0]*0.05*(now-lasttime));camera.setLocY(camerapos.y+cam[1]*0.05*(now-lasttime));camera.setLocZ(camerapos.z+cam[2]*0.05*(now-lasttime));}

        if(keys.isKeyPressed(GLGE.KI_DOWN_ARROW)) {camera.setLocX(camerapos.x-cam[4]*0.05*(now-lasttime));camera.setLocY(camerapos.y-cam[5]*0.05*(now-lasttime));camera.setLocZ(camerapos.z-cam[6]*0.05*(now-lasttime));}               
                
        if(keys.isKeyPressed(GLGE.KI_UP_ARROW)) {camera.setLocX(camerapos.x+cam[4]*0.05*(now-lasttime));camera.setLocY(camerapos.y+cam[5]*0.05*(now-lasttime));camera.setLocZ(camerapos.z+cam[6]*0.05*(now-lasttime));}         

	}
	
	var depla = [0,0,0];
	var depla2 = [0,0,0];
	var idObj;
	var tire = false;
	var finTire = false;
	function panelControle(){
        if(keys.isKeyPressed(GLGE.KI_I)) depla[0] += 0.01;
		else if(depla[0]>=0) depla[0] -= 0.01;
        
		if(keys.isKeyPressed(GLGE.KI_K)) depla[0] += -0.01;
		else if(depla[0]<=0) depla[0] += 0.01;
        
		if(keys.isKeyPressed(GLGE.KI_H)) depla[2] += 0.01;
		else if(depla[2]>=0) depla[2] -= 0.01;
			
        if(keys.isKeyPressed(GLGE.KI_L)) depla[2] += -0.01;
        else if(depla[2]<=0) depla[2] += 0.01;
		
		if(keys.isKeyPressed(GLGE.KI_P)) depla[1] = 0.1;
        if(keys.isKeyPressed(GLGE.KI_M)) depla[1] = -0.1;
        
		if(keys.isKeyPressed(GLGE.KI_SPACE)){ tire = true; idObj = M3D.MOTEUR.getFatherBranch("missile");}
		
		if(tire){
			var test = M3D.MOTEUR.launchProjectile("missile",idObj, depla2, "arme"); 
			if(!test[0]){
				tabObject = test[1];
				tabObject = test[2];
				tabIdObject = test[3]; 
			} else { law(test[1], "missile"); }
			depla2[2] +=0.01;
		}
		
		var newPosVoiture = M3D.MOTEUR.translate("voiture", depla);
		if(newPosVoiture != tabObject["voiture"]){
			law(newPosVoiture, "voiture");
		} else {tabObject["voiture"] = newPosVoiture;}
		
	}
	
	law = function(tab, id){
		if(id = "voiture"){
			if( M3D.MOTEUR.searchTarget(tab,"lapin1") ){
				var colLapin = M3D.MOTEUR.removeObject("lapin1");
				tabObject = colLapin[0];
				tabIdObject = colLapin[1];
			}
		} else if(id == "missile") {
			if( M3D.MOTEUR.searchTarget(tab,"lapin1") ){
				var colLapin = M3D.MOTEUR.removeObject("lapin1");
				tabObject = colLapin[0];
				tabIdObject = colLapin[1];
				var colMissile = M3D.MOTEUR.removeObject("missile");
				tabObject = colMissile[0];
				tabIdObject = colMissile[1];
				var addMissile = M3D.MOTEUR.addObjectIn("missile","missile.dae",[0,0,0,0,0,0,0.5],"arme");
				tabObject = addMissile[0];
				tabIdObject = addMissile[1];
				depla2 = [0,0,0]; tire = false;
			}
		}
	}
	
	levelmap=new GLGE.HeightMap("images/map.png",120,120,-50,50,-50,50,0,50);

	var lasttime=0;
	var frameratebuffer=60;
	start=parseInt(new Date().getTime());
	var now;
	function render(){
		now=parseInt(new Date().getTime());
        frameratebuffer=Math.round(((frameratebuffer*9)+1000/(now-lasttime))/10);
        document.getElementById("debug").innerHTML="Frame Rate:"+frameratebuffer;
		// mouselook();

        positions =[];  positions2 =[];
        checkkeys(tabObject["voiture"]);
        panelControle();
        gameRenderer.render();
        lasttime=now;
	}
	
	setInterval(render,1);
	var inc=0.2;
	document.getElementById("canvas").onmouseover=function(e){mouseovercanvas=true;}
	document.getElementById("canvas").onmouseout=function(e){mouseovercanvas=false;}
}
doc.load("level.xml");

</script>

</body></html>