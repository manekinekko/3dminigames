<html><head> 
 
 
<title>GLGE</title> 
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
 
 
<script type="text/javascript" src="../../glge_math.js"></script> 
<script type="text/javascript" src="../../glge.js"></script> 
<script type="text/javascript" src="../../glge_input.js"></script> 
<script type="text/javascript" src="../../glge_collada.js"></script> 
<!--<script type="text/javascript" src="../../moteur3d.js"></script>-->
<style>
body{background-color: #000;color: #fff;font-family:arial}
</style>
</head><body>

<div id="dump"></div>

<div>
<div style="width:900px;margin:auto;position:relative" id="container">
<canvas id="canvas" width="900" 
height="500"></canvas>
<img src="images/glgelogo.png" alt="GLGElogo" style="position:absolute;top: 450px; left: 750px;" />
<div id="framerate" style="position:absolute; left: 750px; top: 20px; background-color: #000; opacity: 0.5;height: 30px; width: 130px; border-radius: 5px;	-moz-border-radius5px;-webkit-border-radius:5px;border: 1px solid #fff;">
<div id="debug" style="padding: 5px"></div>
</div>
<div style="padding: 5px;position:absolute; left: 20px; top: 370px; background-color: #000; opacity: 0.5;height: 100px; width: 400px; border-radius: 5px;	-moz-border-radius5px;-webkit-border-radius:5px;border: 1px solid #fff;">
<h2 style="margin:0;padding:0;padding-bottom: 5px;font-size: 20px">Collada Demo</h2>
<p style="margin:0;padding:0;padding-bottom: 5px;">Use mode and WASD key to move.</p>
<p style="margin:0;padding:0;padding-bottom: 5px;">Duck and Seymour Plane: <a style="color:#fff" href="http://www.collada.org">www.collada.org</a></p>
</div>
</div>

</div>

<script type="text/javascript">
var tabObject = new Array;
var tabIdObject = new Array;

init = function(list){
	if(list.length!=0){
		var x = list.pop();
		var tabL = x.getLights();
		var tabO = x.getChildren();
		var present = false;
		var j;
		for(var i = 0 ; i<tabO.length ; i++){
			for(j=0; j<tabL.length; j++){ if(tabO[i]==tabL[j]) present = true; }
			if(!present){
				if(tabO[i].id != undefined){
					tabObject[tabO[i].id] = tabO[i];
					tabIdObject[tabIdObject.length] = tabO[i].id;
					list.push(tabO[i]);
				}
			} present = false;
		} 
		init(list);
	} 
}

var doc = new GLGE.Document();
doc.onLoad=function(){
//create the renderer
var gameRenderer=new GLGE.Renderer(document.getElementById('canvas'));
gameScene=new GLGE.Scene();
gameScene=doc.getElement("mainscene");
gameRenderer.setScene(gameScene);
camLookAt = false;

// pour la box
var red=doc.getElement( "red" );
var line=(new GLGE.Object).setDrawType(GLGE.DRAW_LINES);
var positions = [];



var mouse=new GLGE.MouseInput(document.getElementById('canvas'));
var keys=new GLGE.KeyInput();
var mouseovercanvas;
var hoverobj;
lock = true;

var depla = [0,0,0];

console.log(gameScene);
init([gameScene]);
function move(){
	if(keys.isKeyPressed(GLGE.KI_I)) depla[0] += 0.1;
	if(keys.isKeyPressed(GLGE.KI_K)) depla[0] -= 0.1;
	if(keys.isKeyPressed(GLGE.KI_H)) depla[1] += 0.1;
	if(keys.isKeyPressed(GLGE.KI_L)) depla[1] -= 0.1;
	if(keys.isKeyPressed(GLGE.KI_P)) depla[2] += 0.1;
	if(keys.isKeyPressed(GLGE.KI_M)) depla[2] -= 0.1;
	if(keys.isKeyPressed(GLGE.KI_SPACE)){
	
/*
	test = tabObject["lapin1"].getBoundingVolume();
	var minX=(test.center[0]-test.dims[0]/2)*3.0;
	var maxX=(test.center[0]+test.dims[0]/2)*3.0;
	var minY=(test.center[1]-test.dims[1]/2)*3.0;
	var maxY=(test.center[1]+test.dims[1]/2)*3.0;
	var minZ=(test.center[2]-test.dims[2]/2)*3.0;
	var maxZ=(test.center[2]+test.dims[2]/2)*3.0;
	var dims=[maxX-minX,maxY-minY,maxZ-minZ];
	test.dims=dims;
	test.center=[dims[0]/2+minX,dims[1]/2+minY,dims[2]/2+minZ];
	tabObject["lapin1"].boundingVolume = new GLGE.BoundingVolume(minX,maxX,minY,maxY,minZ,maxZ);
	drawBB(tabObject["lapin1"]);
	rescaleObject("lapin1",3.0);
	drawBB(tabObject["lapin1"]);
	var M = GLGE.scaleMatrix(2.0);
	var test = tabObject["lapin1"].getBoundingVolume();
	var V = GLGE.Vec4(test.dims[0],test.dims[1],test.dims[2],1);
	var D = GLGE.mulMat4Vec4(M,V);
	var dims = [GLGE.get1basedVec4(D,1),GLGE.get1basedVec4(D,2),GLGE.get1basedVec4(D,3)];
	test.dims=dims;
	alert(test.dims);
	var minX=(test.center[0]-test.dims[0]/2);
	var maxX=(test.center[0]+test.dims[0]/2);
	var minY=(test.center[1]-test.dims[1]/2);
	var maxY=(test.center[1]+test.dims[1]/2);
	var minZ=(test.center[2]-test.dims[2]/2);
	var maxZ=(test.center[2]+test.dims[2]/2);
	test.center=[dims[0]/2+minX,dims[1]/2+minY,dims[2]/2+minZ];
	tabObject["lapin1"].boundingVolume = new GLGE.BoundingVolume(minX,maxX,minY,maxY,minZ,maxZ);*/
	
	//tab = tabObject["voiture"].getChildren();
	//tab2 = tabObject["perso"].getChildren();
	//alert(tab2);
	
	}
	//alert(tabObject["lapin1"].getObjects().length);
	
	setPosition("voiture", depla);
	//translate("voiture", depla2);
	
}


/*
init = function(racine){
	var tabO = racine.getChildren();
	var tabL = racine.getLights();
	var present = false;
	var j;
	while(indice1<tabO.length){
		var indice2 = 0;
		while(indice2<tabO.length){
			for(j=0; j<tabL.length; j++){ if(tabO[indice2]==tabL[j]) present = true; }
			if(!present){
				if(tabO[indice2].id != undefined){
					tabObject[tabO[indice2].id] = tabO[indice2];
					tabIdObject[tabIdObject.length] = tabO[indice2].id;
					init(tabO[indice2]);
				}
			} present = false;
			indice2++;
		}
		indice1++;
	}
}
*/

addObject = function(idObject,urlObject, tabCoord, idParent){
	tabObject[idObject] = new GLGE.Collada();
	tabObject[idObject].setDocument(urlObject);
	tabObject[idObject].setLoc(tabCoord[0], tabCoord[1], tabCoord[2]);
	tabObject[idObject].setRot(tabCoord[3], tabCoord[4], tabCoord[5]);
	tabObject[idObject].setScale(tabCoord[6]);
	
	if(tabObject[idParent] == undefined) gameScene.addChild(tabObject[idObject]);
	else{ 
		tabObject[idParent].addChild(tabObject[idObject]);
	}
}

drawBB = function(obj){	
	var pos = obj.getPosition();
	var bbox = obj.getBoundingVolume();
	//bas gauche devant
	positions.push(pos.x+bbox.center[0]-bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]-bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]-bbox.dims[2]/2);
	//bas droite devant
	positions.push(pos.x+bbox.center[0]+bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]-bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]-bbox.dims[2]/2);
	//bas gauche derriere
	positions.push(pos.x+bbox.center[0]-bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]+bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]-bbox.dims[2]/2);
	//bas droite derriere
	positions.push(pos.x+bbox.center[0]+bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]+bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]-bbox.dims[2]/2);
	//haut gauche devant
	positions.push(pos.x+bbox.center[0]-bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]-bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]+bbox.dims[2]/2);
	//haut droite devant
	positions.push(pos.x+bbox.center[0]+bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]-bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]+bbox.dims[2]/2);
	//haut gauche derriere
	positions.push(pos.x+bbox.center[0]-bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]+bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]+bbox.dims[2]/2);
	//haut droite derriere
	positions.push(pos.x+bbox.center[0]+bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]+bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]+bbox.dims[2]/2);
	//bas droite devant
	positions.push(pos.x+bbox.center[0]+bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]-bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]-bbox.dims[2]/2);
	//bas droite derriere
	positions.push(pos.x+bbox.center[0]+bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]+bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]-bbox.dims[2]/2);
	//bas gauche devant
	positions.push(pos.x+bbox.center[0]-bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]-bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]-bbox.dims[2]/2);
	//bas gauche derriere
	positions.push(pos.x+bbox.center[0]-bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]+bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]-bbox.dims[2]/2);
	//haut gauche devant
	positions.push(pos.x+bbox.center[0]-bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]-bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]+bbox.dims[2]/2);
	//haut gauche derriere
	positions.push(pos.x+bbox.center[0]-bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]+bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]+bbox.dims[2]/2);
	//haut droite devant
	positions.push(pos.x+bbox.center[0]+bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]-bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]+bbox.dims[2]/2);
	//haut droite derriere
	positions.push(pos.x+bbox.center[0]+bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]+bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]+bbox.dims[2]/2);
	//bas gauche devant
	positions.push(pos.x+bbox.center[0]-bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]-bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]-bbox.dims[2]/2);
	//haut gauche devant
	positions.push(pos.x+bbox.center[0]-bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]-bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]+bbox.dims[2]/2);
	//bas gauche derriere
	positions.push(pos.x+bbox.center[0]-bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]+bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]-bbox.dims[2]/2);
	//haut gauche derriere
	positions.push(pos.x+bbox.center[0]-bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]+bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]+bbox.dims[2]/2);
	//bas droite derriere
	positions.push(pos.x+bbox.center[0]+bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]+bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]-bbox.dims[2]/2);
	//haut droite derriere
	positions.push(pos.x+bbox.center[0]+bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]+bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]+bbox.dims[2]/2);
	//bas droite devant
	positions.push(pos.x+bbox.center[0]+bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]-bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]-bbox.dims[2]/2);
	//haut droite devant
	positions.push(pos.x+bbox.center[0]+bbox.dims[0]/2);
	positions.push(pos.y+bbox.center[1]-bbox.dims[1]/2);
	positions.push(pos.z+bbox.center[2]+bbox.dims[2]/2);
	
	line.setMesh((new GLGE.Mesh).setPositions(positions));
	line.setMaterial(red);
	line.setZtransparent(true);
	gameScene.addObject(line);
}

rotate = function(id,tabRot,idRef){
	if(idRef == null){
		var M = GLGE.identMatrix();
	}else{
		var M = tabObject[idRef].getModelMatrix();
	}
	var V = GLGE.Vec4(tabRot[0],tabRot[1],tabRot[2],1);
	var D = GLGE.mulMat4Vec4(M,V);
	// verifie la collision à l'arrivée
	tabObject[id].setRot(GLGE.get1basedVec4(D,1),GLGE.get1basedVec4(D,2),GLGE.get1basedVec4(D,3));
}

setPosition = function(id,tabPos,idRef){
	if(idRef == null){
		var M = GLGE.identMatrix();
	}else{
		var M = tabObject[idRef].getModelMatrix();
	}
	var V = GLGE.Vec4(tabPos[0],tabPos[1],tabPos[2],1);
	var D = GLGE.mulMat4Vec4(M,V);
	if(!liveCollision(id)) tabObject[id].setLoc(GLGE.get1basedVec4(D,1),GLGE.get1basedVec4(D,2),GLGE.get1basedVec4(D,3));
}

translate = function(id,tabVector,idRef){
	if(idRef == null){
		var M = GLGE.identMatrix();
	}else{
		var M = tabObject[idRef].getModelMatrix();
	}
	var V = GLGE.Vec4(tabVector[0],tabVector[1],tabVector[2],1);
	var D = GLGE.mulMat4Vec4(M,V);
	// verifie la collision sur toute la trajectoire
	tabObject[id].setLoc(GLGE.get1basedVec4(D,1),GLGE.get1basedVec4(D,2),GLGE.get1basedVec4(D,3));
}

collisionPointBoxSimple = function(idObject, ptX, ptY, ptZ){
	var box = tabObject[idObject].getBoundingVolume().dims;
	var pos = tabObject[idObject].getPosition();
	if(ptX >= pos.x 
		&& ptX < pos.x + box[0]
		&& ptY >= pos.y 
		&& ptY < pos.y + box[1]
		&& ptZ >= pos.z 
		&& ptZ < pos.z + box[2]) return true;
	return false;
}

collisionBoxBox = function(idObjectOne, idObjectTwo){
	var posTwo = tabObject[idObjectTwo].getPosition();	
	if(this.collisionPointBoxSimple(idObjectOne, posTwo.x, posTwo.y, posTwo.z)) return true;
	else {
		var boxOne = tabObject[idObjectOne].getBoundingVolume();
		var posOne = tabObject[idObjectOne].getPosition();
		var boxTwo = tabObject[idObjectTwo].getBoundingVolume();
		
		var xminOne = posOne.x+boxOne.center[0]-boxOne.dims[0]/2;
		var xmaxOne = posOne.x+boxOne.center[0]+boxOne.dims[0]/2;
		var yminOne = posOne.y+boxOne.center[1]-boxOne.dims[1]/2;
		var ymaxOne = posOne.y+boxOne.center[1]+boxOne.dims[1]/2;
		var zminOne = posOne.z+boxOne.center[2]-boxOne.dims[2]/2;
		var zmaxOne = posOne.z+boxOne.center[2]+boxOne.dims[2]/2;
		var xminTwo = posTwo.x+boxTwo.center[0]-boxTwo.dims[0]/2;
		var xmaxTwo = posTwo.x+boxTwo.center[0]+boxTwo.dims[0]/2;
		var yminTwo = posTwo.y+boxTwo.center[1]-boxTwo.dims[1]/2;
		var ymaxTwo = posTwo.y+boxTwo.center[1]+boxTwo.dims[1]/2;
		var zminTwo = posTwo.z+boxTwo.center[2]-boxTwo.dims[2]/2;
		var zmaxTwo = posTwo.z+boxTwo.center[2]+boxTwo.dims[2]/2;
		
		if(  xminOne >= xmaxTwo      
		||   xmaxOne <= xminTwo 
		||   yminOne >= ymaxTwo 
		||   ymaxOne <= yminTwo 	
		||   zminOne >= zmaxTwo  
		||   zmaxOne <= zminTwo ) return false;
	} 
	return true;
}

listingTarget = function(idObject){
	tabR = new Array;
	tabO = tabObject[idObject].getChildren();
	present = false;
	
	for(i=0; i<tabIdObject.length; i++){
		for(j=0; j<tabO.length; j++){ if(tabO[j] == tabObject[tabIdObject[i]]) present = true; }
		if(!present && tabIdObject[i] != idObject) tabR[tabR.length] = tabIdObject[i];
		present = false;
	} return tabR;
}

liveCollision = function(id){
    var objectCol = new Array;
	var tab = listingTarget(id);
	for(i=0; i<tab.length; i++){
		if(tab[i] !=  id){
			if(collisionBoxBox(tab[i], id)) objectCol.push(tab[i]);
		}
	} return objectCol;
}

function mouselook(){
	if(mouseovercanvas){
		var mousepos=mouse.getMousePosition();
		mousepos.x=mousepos.x-document.getElementById("container").offsetLeft;
		mousepos.y=mousepos.y-document.getElementById("container").offsetTop;
		var camera=gameScene.camera;
		camerarot=camera.getRotation();
		inc=(mousepos.y-(document.getElementById('canvas').offsetHeight/2))/500;
//		var trans=camera.getRotMatrix().x([0,0,-1,1]);
		var trans=GLGE.mulMat4Vec4(camera.getRotMatrix(),[0,0,-1,1]);
		var mag=Math.pow(Math.pow(trans[0],2)+Math.pow(trans[1],2),0.5);
		trans[0]=trans[0]/mag;
		trans[1]=trans[1]/mag;
		camera.setRotX(1.56-trans[1]*inc);
		camera.setRotZ(-trans[0]*inc);
		var width=document.getElementById('canvas').offsetWidth;
		if(mousepos.x<width*0.3){
			var turn=Math.pow((mousepos.x-width*0.3)/(width*0.3),2)*0.005*(now-lasttime);
			camera.setRotY(camerarot.y+turn);
		}
		if(mousepos.x>width*0.7){
			var turn=Math.pow((mousepos.x-width*0.7)/(width*0.3),2)*0.005*(now-lasttime);
			camera.setRotY(camerarot.y-turn);
		}
	}
}

// Gestion de la caméra au clavier
function checkkeys(){
	var camera=gameScene.camera;
	camerapos=camera.getPosition();
	camerarot=camera.getRotation();
	var cam = camera.getRotMatrix();
	cam = GLGE.inverseMat4(cam);	

	if(keys.isKeyPressed(GLGE.KI_G))
		camLookAt = true; 
	
	if(keys.isKeyPressed(GLGE.KI_F))
		camLookAt = false; 
			
	if(camLookAt){
		var objpos={x:0,y:0,z:0};		
		var coord=[camerapos.x-objpos.x,camerapos.y-objpos.y,camerapos.z-objpos.z];
		var zvec=GLGE.toUnitVec3(coord);
		var xvec=GLGE.toUnitVec3(GLGE.crossVec3([cam[4],cam[5],cam[6]],zvec));
		var yvec=GLGE.toUnitVec3(GLGE.crossVec3(zvec,xvec));		
		camera.setRotMatrix(GLGE.Mat4([xvec[0], yvec[0], zvec[0], 0,
						xvec[1], yvec[1], zvec[1], 0,
						xvec[2], yvec[2], zvec[2], 0,
						0, 0, 0, 1]));
	}

	if(keys.isKeyPressed(GLGE.KI_Z)) {camera.setLocX(camerapos.x-cam[8]*0.05*(now-lasttime));camera.setLocY(camerapos.y-cam[9]*0.05*(now-lasttime));camera.setLocZ(camerapos.z-cam[10]*0.05*(now-lasttime));}

	if(keys.isKeyPressed(GLGE.KI_S)) {camera.setLocX(camerapos.x+cam[8]*0.05*(now-lasttime));camera.setLocY(camerapos.y+cam[9]*0.05*(now-lasttime));camera.setLocZ(camerapos.z+cam[10]*0.05*(now-lasttime));}

	if(keys.isKeyPressed(GLGE.KI_Q)) {camera.setLocX(camerapos.x-cam[0]*0.05*(now-lasttime));camera.setLocY(camerapos.y-cam[1]*0.05*(now-lasttime));camera.setLocZ(camerapos.z-cam[2]*0.05*(now-lasttime));}

	if(keys.isKeyPressed(GLGE.KI_D)) {camera.setLocX(camerapos.x+cam[0]*0.05*(now-lasttime));camera.setLocY(camerapos.y+cam[1]*0.05*(now-lasttime));camera.setLocZ(camerapos.z+cam[2]*0.05*(now-lasttime));}

	if(keys.isKeyPressed(GLGE.KI_DOWN_ARROW)) {camera.setLocX(camerapos.x-cam[4]*0.05*(now-lasttime));camera.setLocY(camerapos.y-cam[5]*0.05*(now-lasttime));camera.setLocZ(camerapos.z-cam[6]*0.05*(now-lasttime));}		
		
	if(keys.isKeyPressed(GLGE.KI_UP_ARROW)) {camera.setLocX(camerapos.x+cam[4]*0.05*(now-lasttime));camera.setLocY(camerapos.y+cam[5]*0.05*(now-lasttime));camera.setLocZ(camerapos.z+cam[6]*0.05*(now-lasttime));}		

}

levelmap=new GLGE.HeightMap("images/map.png",120,120,-50,50,-50,50,0,50);

var lasttime=0;
var frameratebuffer=60;
start=parseInt(new Date().getTime());
var now;
function render(){
    now=parseInt(new Date().getTime());
	    frameratebuffer=Math.round(((frameratebuffer*9)+1000/(now-lasttime))/10);
	    document.getElementById("debug").innerHTML="Frame Rate:"+frameratebuffer;
  // mouselook();

	positions =[];
	checkkeys();
	move();
	gameRenderer.render();
	lasttime=now;
}
setInterval(render,1);
var inc=0.2;
document.getElementById("canvas").onmouseover=function(e){mouseovercanvas=true;}
document.getElementById("canvas").onmouseout=function(e){mouseovercanvas=false;}
}
doc.load("level.xml");
</script>

</body></html>