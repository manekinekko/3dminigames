<!DOCTYPE html>
<html>
    <head>
        <title id="title">3DWIGS</title>
    </head>
	
	<div>
		<div style="width:900px;margin:auto;position:relative" id="container">
			<canvas id="canvas" width="900" height="500"></canvas>
			<div id="framerate" style="position:absolute; left: 750px; top: 20px; background-color: #000; opacity: 0.5;height: 30px; width: 130px; border-radius: 5px;	-moz-border-radius5px;-webkit-border-radius:5px;border: 1px solid #fff;">
				<div id="debug" style="padding: 5px"></div>
			</div>
			<div style="padding: 5px;position:absolute; left: 20px; top: 370px; background-color: #000; opacity: 0.5;height: 100px; width: 400px; border-radius: 5px;	-moz-border-radius5px;-webkit-border-radius:5px;border: 1px solid #fff;">
				<h2 style="margin:0;padding:0;padding-bottom: 5px;font-size: 20px">Demo du moteur3d de 3DWIGS</h2>
				<p style="margin:0;padding:0;padding-bottom: 5px;">Le jeu du lapin </p>
			</div>
		</div>
	</div>
	
    <body>
		<style>
			body{background-color: #000;color: #fff;font-family:arial}
		</style>		
		<script type="text/javascript" src="lib/glge_v0.8/glge-compiled-min.js"></script>
        <script type="text/javascript" src="js/moteur3d.js"></script>
		<script type="text/javascript" src="js/moteur_tools.js"></script>
		<script type="text/javascript" src="js/moteur_management.js"></script>
		<script type="text/javascript" src="js/moteur_collision.js"></script>
		<script type="text/javascript" src="js/moteur_movement.js"></script>
        <script type="text/javascript" src="js/moteur_camera.js"></script>       
		<script type="text/javascript" src="js/moteur_debugger.js"></script>
		<script type="text/javascript" src="js/moteur_keyboard.js"></script>
		<script type="text/javascript" src="js/moteur_physique.js"></script>
			   
		<script type="text/javascript">
			
			var numeroMissile = 0;
			var Missile = [];
			var bazookaCharge = false;
			var gravityObject = [];
			var gravityObjectId = [];
			
			var voiture = new Array;
			voiture.vitesse = [0,0,0];
			voiture.acceleration = [0,0,0];
			voiture.masse = 100;
			voiture.id = "voiture1";
			gravityObject.push(voiture);
			gravityObjectId.push("voiture1");
			
			initScene = function(){
				//M3D.MOTEUR.addObject("lapin","dae/lapin.dae",[0,5,0,0,0,0,1,1,1]);
				M3D.MOTEUR.addObject("sol","dae/sol.dae",[0,-1.2,0,0,0,0,50,50,50],false);
				M3D.MOTEUR.addGroup("voiture1",[0,20,0,0,0,0,1,1,1]);
				M3D.MOTEUR.addGroup("perso",[0,0,0,0,0,0,1,1,1],"voiture1");
				
				M3D.MOTEUR.addObject("jeep1","dae/jeep.dae",[0,0,1,0,0,0,1,1,1],false,"voiture1");
				M3D.MOTEUR.addObject("chasseur1","dae/chasseur.dae",[0,0,1,0,0,0,1,1,1],false,"perso");
				M3D.MOTEUR.addObject("bazooka","dae/bazooka.dae",[0,1.5,1,0,-1.57,0,0.5,0.5,0.5],false,"perso");
				
				M3D.MOTEUR.addObject("lapin","dae/lapin.dae",[10,1,1,0,0,0,1,1,1],false);
				
				M3D.MOTEUR.addCamera("maincamera",[2,5,50,0,0,0]);
				M3D.MOTEUR.activeCamera("maincamera");
				M3D.MOTEUR.setGravite([0,-9.81/60000,0]);
				M3D.MOTEUR.setCoefFrottement(0.01);
				
				setInterval(rendu,10);
			}

			M3D.MOTEUR.initialisation('level.xml','canvas');
			setTimeout("initScene()",100);			
			
			panelControl = function(){			
				//if(KEY_Z) M3D.MOTEUR.translate("voiture1",[0.1,0,0],true,"voiture1");
				//if(KEY_S) M3D.MOTEUR.translate("voiture1",[-0.5,0,0],true,"voiture1");
				if(KEY_Z) {if(voiture.vitesse[0]<1) voiture.acceleration[0] = 0.05;}
				if(KEY_S) {if(voiture.vitesse[0]>-1) voiture.acceleration[0] = -0.05;}
				if(KEY_Q) M3D.MOTEUR.rotate("voiture1",[0,0.05*voiture.vitesse[0],0],false);
				if(KEY_D) M3D.MOTEUR.rotate("voiture1",[0,-0.05*voiture.vitesse[0],0],false);

				if(KEY_O) M3D.MOTEUR.translateCamera("maincamera",[1,0,0],"maincamera");
				if(KEY_L) M3D.MOTEUR.translateCamera("maincamera",[-1,0,0],"maincamera");
				if(KEY_U) M3D.MOTEUR.translateCamera("maincamera",[0,0,1],"maincamera");
				if(KEY_N) M3D.MOTEUR.translateCamera("maincamera",[0,0,-0.01 ],"maincamera");
				if(KEY_K) M3D.MOTEUR.rotateCamera("maincamera",[0,0.05,0]);
				if(KEY_M) M3D.MOTEUR.rotateCamera("maincamera",[0,-0.05,0]);
				
				if(KEY_SPACE) lancer();
				if(KEY_X) charger();
				if(KEY_N) alert(gravityObjectId);
				if(KEY_ENTER) M3D.MOTEUR.test();
			}

			
			charger = function(){
				if(!bazookaCharge){
					bazookaCharge = true;
					Missile[numeroMissile] = new Array;	
					Missile[numeroMissile].acceleration = [0,0,0];
					Missile[numeroMissile].vitesse = [0,0,0];
					Missile[numeroMissile].masse = 20;
					Missile[numeroMissile].id = "missile"+numeroMissile;
					M3D.MOTEUR.addObject("missile"+numeroMissile,"dae/missile.dae",[0,0,0,0,0,0,1,1,1],false,"bazooka");
					numeroMissile += 1;
				}
			}
			
			lancer = function(){
				if(bazookaCharge){
					var num = numeroMissile-1;
					bazookaCharge = false;
					Missile[num].vitesse = [0,0,-5];
					gravityObject.push(Missile[num]);
					gravityObjectId.push("missile"+num);
					M3D.MOTEUR.changeParent("missile"+num);
				}			
			}
			
			supprimerMissile = function(idMissile){
				var num = parseInt(idMissile.substring(7,idMissile.length));
				k=-1;
				for(var i = 0 ; i<gravityObject.length ; i++){
					if(gravityObjectId[i] == idMissile){
						k=i;
					}
				}
				gravityObject.splice(k,1);
				gravityObjectId.splice(k,1);
				M3D.MOTEUR.removeObject(idMissile);
			}
			
			rendu = function(){
				voiture.acceleration = [0,0,0];
				panelControl();
				x = M3D.MOTEUR.applyPhysique([],[],gravityObjectId,gravityObject);
				var k = 0;
				for(var i = 0 ; i<x.length ; i++){
					if(x[i].length > 0){
						if(i==0){ // la voiture peut entrer en collision avec n'importe quoi
							for(var j = 0 ; j<x[i].length ; j++){
								if(x[i][j][1]=="sol"){
									voiture.vitesse[1]=0;
									M3D.MOTEUR.translate("voiture1",[0,-M3D.MOTEUR.ecart("voiture1","sol",1),0],false,"voiture1");
								}
							}
							M3D.MOTEUR.translate("voiture1",voiture.vitesse,false,"voiture1");
						}
						else if(i>0){
							supprime = false;
							for(var j = 0 ; j<x[i].length ; j++){
								if(x[i][j][1]=="sol"){
									supprime = true;
									supprimerMissile(x[i][j][0]);
								}else if(x[i][j][1]=="lapin"){
									supprime = true;
									supprimerMissile(x[i][j][0]);
									M3D.MOTEUR.removeObject("lapin");
								}
							}
							if(!supprime){
								M3D.MOTEUR.translate(gravityObjectId[k],gravityObject[k].vitesse,false,gravityObjectId[k]);
								k += 1;								
							}
						}
					}				
				}
				
				M3D.MOTEUR.render();
			}
			
			window.addEventListener('load', function () {
				window.document.onkeydown = M3D.MOTEUR.checkKeyDown;
				window.document.onkeyup = M3D.MOTEUR.checkKeyUp;
			}, false);

		</script>
    </body>
</html>