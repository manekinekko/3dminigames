<!DOCTYPE html>
<html>
    <head>
        <title id="title">3DWIGS</title>
    </head>
	
	<div>
		<div style="width:900px;margin:auto;position:relative" id="container">
			<canvas id="canvas" width="900" height="500"></canvas>
			<div id="framerate" style="position:absolute; left: 750px; top: 20px; background-color: #000; opacity: 0.5;height: 30px; width: 130px; border-radius: 5px;	-moz-border-radius5px;-webkit-border-radius:5px;border: 1px solid #fff;">
				<div id="debug" style="padding: 5px"></div>
			</div>
			<div style="padding: 5px;position:absolute; left: 20px; top: 370px; background-color: #000; opacity: 0.5;height: 100px; width: 400px; border-radius: 5px;	-moz-border-radius5px;-webkit-border-radius:5px;border: 1px solid #fff;">
				<h2 style="margin:0;padding:0;padding-bottom: 5px;font-size: 20px">Demo du moteur3d de 3DWIGS</h2>
				<p style="margin:0;padding:0;padding-bottom: 5px;">Le jeu du lapin </p>
			</div>
		</div>
	</div>
	
    <body>
		<style>
			body{background-color: #000;color: #fff;font-family:arial}
		</style>	
		
		<script type="text/javascript" src="lib/glge_v0.8/glge-compiled-min.js"></script>
        <script type="text/javascript" src="js/moteur3d.js"></script>
	   
		<script type="text/javascript">
			
			var numeroMissile = 0;
			var Missile = [];
			var bazookaCharge = false;
			var gravityObject = [];
			
			
			initObject = function(gObject){
				gObject.posX = 0;
				gObject.posY = 0;
				gObject.posZ = 0;
				gObject.orX = 0;
				gObject.orY = 0;
				gObject.orZ = 0;
				gObject.sizeX = 1;
				gObject.sizeY = 1;
				gObject.sizeZ = 1;
			}
				
			var sol = new Array;
			initObject(sol);
			sol.id = "sol";
			sol.url = "dae/sol.dae";
			sol.posY = -1.2;
			sol.sizeX = 50;
			sol.sizeY = 50;
			sol.sizeZ = 50;
			
			var voiture = new Array;
			voiture.vitesse = [0,0,0];
			voiture.id = "voiture";
			voiture.acceleration = [0,0,0];
			voiture.masse = 100;
			initObject(voiture);
			voiture.url= "dae/jeep.dae";
			voiture.posY = 10;
			voiture.posZ = 1;
			
			var chasseur = new Array;
			initObject(chasseur);
			chasseur.id = "chasseur";
			chasseur.url = "dae/chasseur.dae";
			chasseur.posZ = 1;
			
			var bazooka = new Array;
			initObject(bazooka);
			bazooka.id = "bazooka";
			bazooka.url = "dae/bazooka.dae"
			bazooka.orY = -1.57;
			bazooka.sizeX = 0.5;
			bazooka.sizeY = 0.5;
			bazooka.sizeZ = 0.5;
			
			var lapin = new Array;
			initObject(lapin);
			lapin.id = "lapin";
			lapin.url = "dae/lapin.dae";
			
			var camera = new Array;
			initObject(camera);
			camera.posX = 2;
			camera.posY = 5;
			camera.posZ = 50;
			camera.id = "maincamera";
			
			gravityObject.push(voiture);

			initScene = function(){
				M3D.MOTEUR.addObject(sol,false);
				
				M3D.MOTEUR.addObject(voiture,false);
	
				M3D.MOTEUR.addObject(chasseur,false,voiture.id);

				M3D.MOTEUR.addObject(bazooka,false,chasseur.id);
				M3D.MOTEUR.setPosition(bazooka,[0,1.5,1],false,chasseur.id);

				M3D.MOTEUR.addObject(lapin,false);
				M3D.MOTEUR.setPosition(lapin,[10,1,0],false);
				
				M3D.MOTEUR.addCamera(camera);
				M3D.MOTEUR.activeCamera(camera.id);
				
				M3D.MOTEUR.setGravite([0,-9.81/60000,0]);
				M3D.MOTEUR.setCoefFrottement(0.01);
				setInterval(rendu,10);
			}

			M3D.MOTEUR.initialisation('js/level.xml','canvas','initScene()');		
			
			panelControl = function(){			
				//if(KEY_Z) M3D.MOTEUR.translate("voiture1",[0.1,0,0],true,"voiture1");
				//if(KEY_S) M3D.MOTEUR.translate("voiture1",[-0.5,0,0],true,"voiture1");
				if(KEY_Z) {if(voiture.vitesse[0]<1) voiture.acceleration[0] = 0.05;}
				if(KEY_S) {if(voiture.vitesse[0]>-1) voiture.acceleration[0] = -0.05;}
				if(KEY_Q) M3D.MOTEUR.rotate(voiture,[0,0.05*voiture.vitesse[0],0],false);
				if(KEY_D) M3D.MOTEUR.rotate(voiture,[0,-0.05*voiture.vitesse[0],0],false);

				if(KEY_O) M3D.MOTEUR.translateCamera(camera,[1,0,0],"maincamera");
				if(KEY_L) M3D.MOTEUR.translateCamera(camera,[-1,0,0],"maincamera");
				if(KEY_U) M3D.MOTEUR.translateCamera(camera,[0,0,1],"maincamera");
				if(KEY_N) M3D.MOTEUR.translateCamera(camera,[0,0,-0.01 ],"maincamera");
				if(KEY_K) M3D.MOTEUR.rotateCamera(camera,[0,0.05,0]);
				if(KEY_M) M3D.MOTEUR.rotateCamera(camera,[0,-0.05,0]);
				
				if(KEY_SPACE) lancer();
				if(KEY_X) charger();
				if(KEY_W) alert(M3D.MOTEUR.getGlobalPosition(chasseur.id));
			}

			
			charger = function(){
				if(!bazookaCharge){
					bazookaCharge = true;
					Missile[numeroMissile] = new Array;	
					Missile[numeroMissile].acceleration = [0,0,0];
					Missile[numeroMissile].vitesse = [0,0,0];
					Missile[numeroMissile].masse = 20;
					Missile[numeroMissile].id = "missile"+numeroMissile;
					initObject(Missile[numeroMissile]);							
					Missile[numeroMissile].url = "dae/missile.dae";
					M3D.MOTEUR.addObject(Missile[numeroMissile],false,bazooka.id);
					M3D.MOTEUR.setPosition(Missile[numeroMissile],[0,0,0],false,bazooka.id);
					M3D.MOTEUR.changeParent(Missile[numeroMissile],bazooka.id);
					numeroMissile += 1;
				}
			}
			
			lancer = function(){
				if(bazookaCharge){
					var num = numeroMissile-1;
					bazookaCharge = false;
					Missile[num].vitesse = [0,0,-3];
					gravityObject.push(Missile[num]);
					M3D.MOTEUR.changeParent(Missile[num]);
				}			
			}
			
			supprimerMissile = function(idMissile){
				var num = parseInt(idMissile.substring(7,idMissile.length));
				k=-1;
				for(var i = 0 ; i<gravityObject.length ; i++){
					if(gravityObject[i].id == idMissile){
						k=i;
					}
				}
				gravityObject.splice(k,1);
				M3D.MOTEUR.removeObject(idMissile);
			}
			
			rendu = function(){
				voiture.acceleration = [0,0,0];
				panelControl();

				x = M3D.MOTEUR.applyPhysique([],gravityObject);
				var k = 1;
				for(var i = 0 ; i<x.length ; i++){
					if(x[i].length > 0){
						if(i==0){ // la voiture peut entrer en collision avec n'importe quoi
							for(var j = 0 ; j<x[i].length ; j++){
								if(x[i][j][1]=="sol"){
									voiture.vitesse[1]=0;
									M3D.MOTEUR.translate(voiture,[0,-M3D.MOTEUR.ecart(voiture.id,sol.id,2),0],false,voiture.id);
								}
							}
							M3D.MOTEUR.translate(voiture,voiture.vitesse,false,voiture.id);
						}
						else if(i>0){
							supprime = false;
							for(var j = 0 ; j<x[i].length ; j++){
								if(x[i][j][1]=="sol"){
									supprime = true;
									supprimerMissile(x[i][j][0]);
								}else if(x[i][j][1]=="lapin"){
									supprime = true;
									supprimerMissile(x[i][j][0]);
									M3D.MOTEUR.removeObject("lapin");
								}
							}
							if(!supprime){
								M3D.MOTEUR.translate(gravityObject[k],gravityObject[k].vitesse,false,gravityObject[k].id);
								k += 1;								
							}
						}
					}				
				}
				M3D.MOTEUR.render();
			}
			
			window.addEventListener('load', function () {
				window.document.onkeydown = M3D.MOTEUR.checkKeyDown;
				window.document.onkeyup = M3D.MOTEUR.checkKeyUp;
			}, false);

		</script>
    </body>
</html>