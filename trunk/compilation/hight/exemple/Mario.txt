//////////// PRESENTATION ////////////
// Mario est sur une grande plateforme de départ, il y a un goomba.
// Il y a une cinématique de départ, puis dès qu'il saute sur une plateforme, 3 à 5 plateformes sont générées devant lui
// Les plates formes sont détruites derrière lui régulièrement.
// Normalement dans un mario en 3D type 64 ou sunshine, l'environnement n'est pas généré aléatoirement, 
// mais c'est possible dans de rares cas et notre grammaire doit donc en offrir la posibilité

//////////// INITIALISATION ////////////

joueur_principal is Player solo;
joueur_principal has controller at "human";
ordinateur is Player solo;
ordinateur has controller at "ia1";

cam is camera;
cam has view at thirdPerson;

//une zone devant le joueur
zoneGenNouvellePlateforme is Zone;
//une derrière
zoneDestroyPlateforme is Zone
// quand mario tombe dans le vide
zoneDeVide is Zone;

// Personnage joueur
mario is Character ;
mario has zoneGenNouvellePlateforme, zoneDestroyPlateforme;
mario has moveWithCamera cam;
mario has life at 2;
mario has nbLives at 3;
c_vide is CopyConstraint;
c_vide has target at mario, transformation at "translation", coordinates at 1 1 0, offset at false;
zoneDeVide has constraints at c_vide;

// Ennemis
goomba is Character duplicable;
teteGoomba is Zone;
goomba has teteGoomba;
teteGoomba has position at 0 0 10;
goomba has attack at 1;
goomba has life at 1;

superGoomba is Character duplicable;
teteSuperGoomba is Zone;
superGoomba has teteSuperGoomba;
teteSuperGoomba has position at 0 0 10;
superGoomba has attack at 1;
superGoomba has life at 2;

// Scene
plateformeDepart is Ground;
plateforme is Platform duplicable;

plateforme has goomba, superGoomba;

// au dessus de la zone de depart, pos absolue
mario has position at xx yy zz;
// au loin devant             
zoneGenNouvellePlateforme has position at 200 0 0;
// au loin derrière
zoneDestroyPlateforme has position at -200 0 0;
// en dessous de mario  
zoneDeVide has position at 0 0 -100;

//////////// DEFINITIONS ////////////

definition cinematique1 means
		desactivate commands,    //ou desactivate nomCommand
		activate P,              //le client veut laisser la pause par exemple
		mario move forward by 5 during 2 sec,
		generate 1 goomba on plateformeDepart,
		mario jump by 10,
		activate commands;


//////////// COMMANDES ////////////
command mario for joueur_principal is 
	space for mario jump by 10, 
	key Z for mario move forward by 10,    //avec l'accélération qu'on a appelé (sinon il se serait déplacé directement lors d'un appui sur la touche)
	key S for mario move backward by 10,
	key Q for mario move left by 10,
	key D for mario move right by 10,
// avec le "mario has moveWithCamera cam" il avance vers la caméra
	key P for pause;


//////////// REGLES DU JEU ////////////
rule mario touches teteGoomba         //une en particulier qui a été générée parmi toutes (= celle que le mario touche)
    then 
        goomba dies,  // implique que l'objet 3D est détruit
        add 1 for nbOfJumpInTheAir,    //pour le faire rebondir
        mario jump by 10,
        sub 1 for nbOfJumpInTheAir,
        add 100 for score of joueur_principal;

rule mario touches teteSuperGoomba         //une en particulier qui a été générée parmi toutes (= celle que le mario touche)
    then 
        sub 1 for life of superGoomba, 
        add 1 for nbOfJumpInTheAir,    //pour le faire rebondir
        mario jump by 10,
        sub 1 for nbOfJumpInTheAir,
        add 300 for score of joueur_principal;

rule goomba dies 
	then
		assign 0 for z of size of goomba; //il est écrasé

rule superGoomba dies
	then
		assign 0 for z of size of superGoomba;     //il est écrasé


rule zoneDestroyPlateforme touches plateforme 
	then
		destroy plateforme;             //le destroy s'effectue sur la plateforme définie dans le déclencheur de la règle

rule mario touches plateforme     //s'il atterit dessus et qu'il y a la place pour générerer de nouvelles plateformes 
	then 
		if zoneGenNouvellePlateforme touches other plateforme
		then generate 1 plateforme in zoneGenNouvellePlateforme
		else generate (random between 2 and 3) plateforme in zoneGenNouvellePlateforme   //random pour une zone
		endif;

rule mario touches zoneDeVide
	then
		mario dies;
		
		
mario touches goomba then 
	sub attack of goomba to life of mario,
	assign true to isTraversable of mario,
	wait 4 s then
		assign false to isTraversable of mario
	endwait
		
mario touches superGoomba then 
	sub attack of superGoomba to life of mario,
	assign true to isTraversable of mario,
	wait 4 s then
		assign false to isTraversable of mario
	endwait
	
		
rule mario dies then 
	if nbLives of mario <= 0 then
		Game ends;
	else 
		sub 1 to nbLives of mario,
		wait 2 s then
			generate mario on plateforme //random
		endwait
	endif
//il n'y a pas de victoire ni de défaite dans ce jeu

rule Game starts
	then
		generate plateformeDepart,
		generate 1 plateforme in zoneGenNouvellePlateforme,
		generate mario,
		cinematique1;


rule plateforme is generated
	then
		generate random between 0 and 1 goomba on plateforme,    // sur la plateforme qui vient d'être générée
		generate random between -2 and 2 superGoomba on plateforme; //si nb négatif pour un generate -> 0 donc 50% de chance d'avoir un goomba, 25% d'en avoir 2


rule true then
	if distance between plateforme and mario > 400 then
		destroy plateforme
	endif

//////////// IA ////////////
ai ia1 is

rule true then
	goomba move left by 5 during 2 sec,
	goomba move right by 5 during 2 sec;
;
rule true then
	superGoomba move left by 10 during 2 sec,
	superGoomba jump by 5,
	superGoomba move right by 10 during 2 sec,
	superGoomba jump by 5;
;



